name: Create Docker Release

on:
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version bump type (only used for main branch releases)'
        required: false
        default: 'patch'
        type: choice
        options:
        - major
        - minor  
        - patch

env:
  GIT_USER_NAME: GitHub Pipeline
  GIT_USER_EMAIL: github_pipeline@fairagro.net
  IMAGE_NAME: fairagro_advanced_middleware_api
  DOCKERHUB_NAMESPACE: zalf
  IMAGE_TITLE: FairAgro Advanced Middleware API
  IMAGE_DESCRIPTION: Advanced middleware API for FairAgro platform

jobs:
  calculate-version:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      version: ${{ steps.set_version.outputs.version }}
      release-type: ${{ steps.gitversion.outputs.release-type }}
      
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - uses: gittools/actions/gitversion/setup@v4
        with:
          versionSpec: '6.x'
          
      - name: Configure GitVersion and calculate version
        id: gitversion
        run: |
          # Determine increment and release type
          if [[ "${{ github.ref_name }}" == feature/* ]]; then
            INCREMENT="patch"
            RELEASE_TYPE="feature"
            echo "üåø Feature release - patch increment"
          else
            INCREMENT="${{ github.event.inputs.version_bump || 'patch' }}"
            RELEASE_TYPE="final"
            echo "üöÄ Final release - $INCREMENT increment"
          fi
          
          # Create GitVersion config
          cat > GitVersion.yml << EOF
          tag-prefix: v
          mode: ContinuousDeployment
          branches:
            main:
              label: ''
              increment: $INCREMENT
            feature:
              regex: ^feature/(?<BranchName>.+)$
              label: '{BranchName}'
              increment: Inherit
          EOF
          
          echo "release-type=$RELEASE_TYPE" >> $GITHUB_OUTPUT
          
      - name: Execute GitVersion
        uses: gittools/actions/gitversion/execute@v4
        
      - name: Set final version
        id: set_version
        run: |
          if [[ "${{ github.ref_name }}" == feature/* ]]; then
            VERSION="${{ steps.gitversion.outputs.semVer }}"
          else
            VERSION="${{ steps.gitversion.outputs.majorMinorPatch }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Final version: v$VERSION"

  build-docker-image:
    needs: [calculate-version]
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      security-events: write  # Required for SARIF upload
      
    outputs:
      image-digest: ${{ steps.build.outputs.digest }}
      image-tags: ${{ steps.build.outputs.tags }}
      dockerhub-pushed: ${{ steps.dockerhub_secrets.outputs.available }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Check DockerHub secrets
        id: dockerhub_secrets
        run: |
          if [[ -n "${{ secrets.DOCKERHUB_USER }}" && -n "${{ secrets.DOCKERHUB_TOKEN }}" ]]; then
            echo "available=true" >> $GITHUB_OUTPUT
            echo "‚úÖ DockerHub secrets are available"
          else
            echo "available=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è DockerHub secrets not available - will only push to GitHub Container Registry"
          fi

      - name: Log in to DockerHub
        if: steps.dockerhub_secrets.outputs.available == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USER }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ steps.dockerhub_secrets.outputs.available == 'true' && format('{0}/{1}', env.DOCKERHUB_NAMESPACE, env.IMAGE_NAME) || format('local/{0}', env.IMAGE_NAME) }}
          tags: |
            type=raw,value=${{ needs.calculate-version.outputs.version }}
            type=raw,value=latest,enable=${{ needs.calculate-version.outputs.release-type == 'final' }}
          labels: |
            org.opencontainers.image.title=${{ env.IMAGE_TITLE }}
            org.opencontainers.image.description=${{ env.IMAGE_DESCRIPTION }}
            org.opencontainers.image.url=https://github.com/${{ github.repository }}
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.version=v${{ needs.calculate-version.outputs.version }}
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
            org.opencontainers.image.revision=${{ github.sha }}
            
      - name: Build Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64
          push: ${{ steps.dockerhub_secrets.outputs.available == 'true' }}
          load: true
          tags: |
            local/${{ env.IMAGE_NAME }}:${{ needs.calculate-version.outputs.version }}
            ${{ steps.dockerhub_secrets.outputs.available == 'true' && format('{0}/{1}:{2}', env.DOCKERHUB_NAMESPACE, env.IMAGE_NAME, needs.calculate-version.outputs.version) || '' }}
            ${{ steps.dockerhub_secrets.outputs.available == 'true' && needs.calculate-version.outputs.release-type == 'final' && format('{0}/{1}:latest', env.DOCKERHUB_NAMESPACE, env.IMAGE_NAME) || '' }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            APP_VERSION=v${{ needs.calculate-version.outputs.version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          
      - uses: anchore/sbom-action@v0
        with:
          image: local/${{ env.IMAGE_NAME }}:${{ needs.calculate-version.outputs.version }}
          output-file: sbom.spdx.json
          format: spdx-json
          
      - uses: actions/upload-artifact@v4
        with:
          name: sbom-v${{ needs.calculate-version.outputs.version }}
          path: sbom.spdx.json
          
      - uses: aquasecurity/trivy-action@master
        with:
          image-ref: local/${{ env.IMAGE_NAME }}:${{ needs.calculate-version.outputs.version }}
          format: sarif
          output: trivy-results.sarif
          
      - uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-results.sarif

  create-release:
    needs: [calculate-version, build-docker-image]
    runs-on: ubuntu-latest
    if: needs.build-docker-image.result == 'success' && needs.calculate-version.outputs.release-type == 'final' && github.ref_name == 'main'
    
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - uses: actions/download-artifact@v4
        with:
          name: sbom-v${{ needs.calculate-version.outputs.version }}
          
      - name: Create timestamp tag and release
        run: |
          git config --local user.email "${{ env.GIT_USER_EMAIL }}"
          git config --local user.name "${{ env.GIT_USER_NAME }}"
          
          # Create timestamp tag
          RELEASE_TAG="$(date +%Y%m%d%H%M%S)-docker-v${{ needs.calculate-version.outputs.version }}"
          git tag "$RELEASE_TAG" && git push origin "$RELEASE_TAG" || echo "Tag exists"
          
          # Check if release exists
          if gh release view "$RELEASE_TAG" --json isDraft --jq '.isDraft' 2>/dev/null | grep -q true; then
            echo "Updating draft release"
          elif gh release view "$RELEASE_TAG" >/dev/null 2>&1; then
            echo "Final release exists, exiting" && exit 1
          fi
          
          # Export for use in GitHub Release
          echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
          
      - name: Create GitHub Release
        if: needs.calculate-version.outputs.release-type == 'final' && github.ref_name == 'main'
        run: |
          # Check if release already exists
          RELEASE_TAG="${{ steps.create_tags.outputs.release_tag }}"
          
          if gh release view "$RELEASE_TAG" --json isDraft --jq '.isDraft' 2>/dev/null | grep -q true; then
            echo "Draft release exists, updating it"
          elif gh release view "$RELEASE_TAG" >/dev/null 2>&1; then
            echo "Final release already exists, skipping creation"
            exit 0
          fi
          
          # Create or update draft release
          gh release create "$RELEASE_TAG" sbom.spdx.json \
            --title "Docker Release v${{ needs.calculate-version.outputs.version }}" \
            --notes "## Software Release v${{ needs.calculate-version.outputs.version }}
            
            This is a **${{ needs.calculate-version.outputs.release-type }}** release triggered manually.
            
            ### Version Increment
            - **Type**: ${{ github.event.inputs.version_bump || 'patch (feature)' }}
            - **Branch**: ${{ github.ref_name }}
            
            ## üê≥ Docker Image
            
            The Docker image is the primary deliverable of this release.
            
            ${{ secrets.DOCKERHUB_USER && format('```bash
            docker pull {0}/{1}:{2}
            ```', env.DOCKERHUB_NAMESPACE, env.IMAGE_NAME, needs.calculate-version.outputs.version) || '**Note**: Docker image was built locally but not pushed to DockerHub (missing secrets).' }}
            
            ### Image Details
            ${{ secrets.DOCKERHUB_USER && format('- **DockerHub**: `{0}/{1}`', env.DOCKERHUB_NAMESPACE, env.IMAGE_NAME) || '- **DockerHub**: Not configured (missing secrets)' }}
            - **Tag**: \`${{ needs.calculate-version.outputs.version }}\`
            ${{ needs.build-docker-image.outputs.image-digest && format('- **Digest**: `{0}`', needs.build-docker-image.outputs.image-digest) || '' }}
            - **Platforms**: linux/amd64
            
            ### üìã Security & Compliance
            - ‚úÖ Image scanned with Trivy (results in Security tab)
            - ‚úÖ SBOM (Software Bill of Materials) attached to this release
            - ‚úÖ Single-platform build for performance
            - ‚úÖ Security-focused container image
            
            ### üîÑ Source Code Reproduction
            \`\`\`bash
            git checkout v${{ needs.calculate-version.outputs.version }}
            docker build -t local-build:${{ needs.calculate-version.outputs.version }} .
            \`\`\`
            
            ### Helm Deployment
            ${{ secrets.DOCKERHUB_USER && format('```bash
            helm upgrade --install fairagro-middleware ./helm \\
              --set image.tag={0} \\
              --set image.repository={1}/{2}
            ```', needs.calculate-version.outputs.version, env.DOCKERHUB_NAMESPACE, env.IMAGE_NAME) || '**Note**: Configure DockerHub secrets to enable Helm deployment with DockerHub images.' }}
            
            **Full Changelog**: https://github.com/${{ github.repository }}/compare/v${{ needs.calculate-version.outputs.version }}...HEAD" \
            --draft --latest || echo "Release creation/update completed"
            
          # Finalize the draft release (makes it immutable if GitHub setting is enabled)
          echo "Finalizing draft release..."
          gh release edit "$RELEASE_TAG" --draft=false
          echo "‚úÖ Release published and finalized"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-helm-chart:
    needs: [calculate-version, build-docker-image, create-release]
    runs-on: ubuntu-latest
    if: needs.create-release.result == 'success' && needs.build-docker-image.outputs.dockerhub-pushed == 'true'
    
    permissions:
      contents: write
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Update and commit Chart.yaml
        run: |
          sed -i "s/^appVersion:.*/appVersion: \"${{ needs.calculate-version.outputs.version }}\"/" helm/Chart.yaml
          
          git config --local user.email "${{ env.GIT_USER_EMAIL }}"
          git config --local user.name "${{ env.GIT_USER_NAME }}"
          
          git add helm/Chart.yaml
          git diff --staged --quiet || git commit -m "chore(helm): update appVersion to ${{ needs.calculate-version.outputs.version }}"
          git push