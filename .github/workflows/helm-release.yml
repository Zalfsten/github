name: Create Helm Chart Release

on:
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version bump type for Helm chart release'
        required: true
        default: 'patch'
        type: choice
        options:
        - major
        - minor  
        - patch

env:
  GIT_USER_NAME: GitHub Pipeline
  GIT_USER_EMAIL: github_pipeline@fairagro.net
  DOCKERHUB_NAMESPACE: zalf
  IMAGE_NAME: fairagro_advanced_middleware_api

jobs:
  helm-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - uses: gittools/actions/gitversion/setup@v4
        with:
          versionSpec: '6.x'
          
      - name: Configure GitVersion and calculate version
        run: |
          # Determine increment and release type
          if [[ "${{ github.ref_name }}" == feature/* ]]; then
            INCREMENT="patch"
            RELEASE_TYPE="feature"
            echo "üåø Helm feature release"
          else
            INCREMENT="${{ github.event.inputs.version_bump }}"
            RELEASE_TYPE="final"
            echo "üöÄ Helm final release - $INCREMENT increment"
          fi
          
          # Create GitVersion config
          cat > GitVersion.yml << EOF
          mode: ContinuousDeployment
          tag-prefix: ''
          tag-pattern: '^(?<timestamp>\d{14})-chart-v(?<version>\d+\.\d+\.\d+(?:-[0-9A-Za-z-]+(?:\.[0-9A-Za-z-]+)*)?)$'
          semantic-version-format: Strict
          branches:
            main:
              label: ''
              increment: $INCREMENT
            feature:
              regex: ^feature/(?<BranchName>.+)$
              label: '{BranchName}'
              increment: Inherit
          EOF
          
          echo "RELEASE_TYPE=$RELEASE_TYPE" >> $GITHUB_ENV
          
      - uses: gittools/actions/gitversion/execute@v4
        id: gitversion
        
      - uses: azure/setup-helm@v4
        with:
          version: '3.14.0'
          
      - name: Create Helm release
        run: |
          # Determine version
          if [[ "${{ github.ref_name }}" == feature/* ]]; then
            VERSION="${{ steps.gitversion.outputs.semVer }}"
          else
            VERSION="${{ steps.gitversion.outputs.majorMinorPatch }}"
          fi
          
          # Extract appVersion
          APP_VERSION=$(grep '^appVersion:' helm/Chart.yaml | sed 's/appVersion: *"*\([^"]*\)"*/\1/')
          
          # Create timestamp tag (always for all releases)
          RELEASE_TAG="$(date +%Y%m%d%H%M%S)-chart-v$VERSION"
          git config --local user.email "${{ env.GIT_USER_EMAIL }}"
          git config --local user.name "${{ env.GIT_USER_NAME }}"
          git tag "$RELEASE_TAG" && git push origin "$RELEASE_TAG" || echo "Tag exists"
          
          # Package Helm chart
          helm package ./helm --version "$VERSION" --app-version "$APP_VERSION"
          
          # Only create GitHub release for final releases (main branch)
          if [[ "$RELEASE_TYPE" == "final" ]]; then
            echo "Creating GitHub release for final Helm release"
            
            # Create release (draft first, then finalize)
            gh release create "$RELEASE_TAG" "${{ env.IMAGE_NAME }}-$VERSION.tgz" \
              --title "Helm Chart Release v$VERSION" \
              --notes "## Helm Chart Release v$VERSION
              
            **Chart Version**: $VERSION  
            **App Version**: $APP_VERSION
            
            \`\`\`bash
            helm upgrade --install fairagro-middleware ./helm \\
              --set image.tag=$APP_VERSION \\
              --set image.repository=${{ env.DOCKERHUB_NAMESPACE }}/${{ env.IMAGE_NAME }}
            \`\`\`" \
              --draft || gh release edit "$RELEASE_TAG" --draft=false
          else
            echo "Feature release - Git tag created but no GitHub release"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Push to DockerHub
        if: always()
        run: |
          # Check if we should push based on release type
          if [[ "$RELEASE_TYPE" != "final" && "$RELEASE_TYPE" != "feature" ]]; then
            echo "‚è≠Ô∏è Skipping DockerHub push - not a final or feature release"
            exit 0
          fi
          if [[ -n "${{ secrets.DOCKERHUB_USER }}" && -n "${{ secrets.DOCKERHUB_TOKEN }}" ]]; then
            VERSION="${{ steps.gitversion.outputs.semVer }}"
            [[ "${{ github.ref_name }}" != feature/* ]] && VERSION="${{ steps.gitversion.outputs.majorMinorPatch }}"
            
            echo "${{ secrets.DOCKERHUB_TOKEN }}" | helm registry login registry-1.docker.io -u ${{ secrets.DOCKERHUB_USER }} --password-stdin
            helm push "${{ env.IMAGE_NAME }}-$VERSION.tgz" oci://registry-1.docker.io/${{ env.DOCKERHUB_NAMESPACE }}
            echo "‚úÖ Pushed to DockerHub: ${{ env.DOCKERHUB_NAMESPACE }}/${{ env.IMAGE_NAME }}:$VERSION"
          else
            echo "‚ö†Ô∏è Skipping DockerHub push - missing secrets"
          fi
